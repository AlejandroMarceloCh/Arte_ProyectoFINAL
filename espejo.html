<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla 2: Espejo</title>
    <style>
        body { 
            background: #000; 
            margin: 0; 
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        #mirror {
            width: 100vw; 
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1);
            transition: filter 1s ease;
        }
        
        #status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-family: 'Inter', -apple-system, sans-serif;
            backdrop-filter: blur(10px);
            z-index: 100;
            max-width: 300px;
        }
        
        #status-title {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        #status-value {
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        #effect-name {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 25px;
            border-radius: 20px;
            font-family: 'Inter', -apple-system, sans-serif;
            backdrop-filter: blur(10px);
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #effect-name.show {
            opacity: 1;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 59, 48, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            font-family: 'Inter', -apple-system, sans-serif;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Iniciando c√°mara...</div>
    <video id="mirror" autoplay playsinline muted></video>
    
    <div id="status">
        <div id="status-title">Distorsi√≥n</div>
        <div id="status-value">0%</div>
    </div>
    
    <div id="effect-name"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // === 1. PEGA TU CONFIGURACI√ìN DE FIREBASE AQU√ç ===
        const firebaseConfig = {
                apiKey: "AIzaSyDk6DLABMQ",
                authDomain: "eco-pro3fea1.firebaseapp.com",

                };

        // === ELEMENTOS ===
        const videoElement = document.getElementById('mirror');
        const statusValue = document.getElementById('status-value');
        const effectName = document.getElementById('effect-name');
        const loadingEl = document.getElementById('loading');
        
        // === INICIALIZAR FIREBASE ===
        let database, distortionRef;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            distortionRef = database.ref('distortion');
            console.log('‚úÖ Firebase conectado');
        } catch (error) {
            console.error('‚ùå Error Firebase:', error);
            showError('Error al conectar con Firebase');
        }

        // === ACTIVAR C√ÅMARA ===
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        })
        .then(stream => {
            videoElement.srcObject = stream;
            loadingEl.style.display = 'none';
            console.log('‚úÖ C√°mara activada');
        })
        .catch(err => {
            console.error('‚ùå Error de c√°mara:', err);
            showError('No se pudo acceder a la c√°mara. Verifica los permisos.');
        });

        // === EFECTOS POR TIPO ===
        const effectNames = {
            'reels': 'üì± Modo Scroll Zombie',
            'casino': 'üé∞ Sobreestimulaci√≥n',
            'message': 'üí¨ Ansiedad Digital',
            'passive': '‚è±Ô∏è Degradaci√≥n Pasiva'
        };

        function showEffectName(type) {
            effectName.textContent = effectNames[type] || 'Efecto Desconocido';
            effectName.classList.add('show');
            setTimeout(() => {
                effectName.classList.remove('show');
            }, 2000);
        }

        // === ESCUCHAR CAMBIOS DE FIREBASE (CORREGIDO) ===
        if (distortionRef) {
            distortionRef.on('value', snapshot => {
                const data = snapshot.val();
                
                // CORRECCI√ìN: Se comprueba que `data.level` no sea indefinido (para que 0 funcione)
                if (data && typeof data.level !== 'undefined') {
                    const level = Math.min(Math.max(data.level, 0), 100);
                    const type = data.type || 'passive';
                    
                    console.log(`üìä Distorsi√≥n: ${level}% | Tipo: ${type}`);
                    
                    // Actualizar UI
                    statusValue.textContent = Math.round(level) + '%';
                    showEffectName(type);
                    
                    // Aplicar filtro seg√∫n tipo
                    applyFilter(type, level);
                }
            }, error => {
                console.error('‚ùå Error al leer datos:', error);
            });
        }

        // === APLICAR FILTROS ===
        function applyFilter(type, level) {
            let filter = '';
            
            switch(type) {
                case 'reels':
                    // Efecto zombie de scroll: descolorido y borroso
                    filter = `
                        grayscale(${level}%) 
                        blur(${level / 8}px)
                        brightness(${100 - level / 4}%)
                    `;
                    break;
                    
                case 'casino':
                    // Sobreestimulaci√≥n: colores intensos y distorsionados
                    filter = `
                        saturate(${100 + level * 2}%) 
                        contrast(${100 + level}%) 
                        hue-rotate(${level * 3}deg)
                        brightness(${100 + level / 3}%)
                    `;
                    break;
                    
                case 'message':
                    // Ansiedad: sepia con desaturaci√≥n
                    filter = `
                        grayscale(${level / 2}%) 
                        sepia(${Math.min(level, 70)}%)
                        contrast(${90 + level / 4}%)
                    `;
                    break;
                    
                default: // 'passive'
                    // Degradaci√≥n pasiva: p√©rdida gradual de color
                    filter = `
                        grayscale(${level}%) 
                        brightness(${100 - level / 2}%)
                        contrast(${100 - level / 3}%)
                    `;
            }
            
            videoElement.style.filter = filter.trim();
        }

        // === MANEJO DE ERRORES ===
        function showError(message) {
            loadingEl.style.display = 'none';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <h2>‚ö†Ô∏è Error</h2>
                <p>${message}</p>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 15px;">
                    Intenta recargar la p√°gina o verifica la configuraci√≥n.
                </p>
            `;
            document.body.appendChild(errorDiv);
        }

        // === LOG INICIAL ===
        console.log('üé¨ Pantalla Espejo iniciada');
        console.log('üìπ Esperando datos de distorsi√≥n...');
    </script>
</body>
</html>